
document.addEventListener("DOMContentLoaded", function () {

	window.onload = function () {
		var preloader = document.querySelector('.preloader');
		if (preloader) {
			setTimeout(function () {
				preloader.classList.add('loaded');
			}, 1000);
		}
	}



		// ===== webp =====

		(function () {

			function testWebP(callback) {

				var webP = new Image();
				webP.onload = webP.onerror = function () {
					callback(webP.height == 2);
				};
				webP.src = "data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA";
			}

			testWebP(function (support) {

				if (support == true) {
					document.querySelector('body').classList.add('webp');
				} else {
					document.querySelector('body').classList.add('no-webp');
				}
			});
		}());


	// ==== rezet focus ====

	(function () {
		var button = document.querySelectorAll('a, button, label, input');

		var isMouseDown = false;

		for (var i = 0; i < button.length; i++) {
			var el = button[i];

			if (el.tagName !== 'LABEL') {
				el.classList.add('focus');
			}

			el.addEventListener('mousedown', function () {
				this.classList.remove('focus');
				isMouseDown = true;
			});
			el.addEventListener('keydown', function (e) {
				if (e.key === "Tab") {
					isMouseDown = false;
				}
			});
			el.addEventListener('focus', function () {
				if (isMouseDown) {
					this.classList.remove('focus');
				}
			});
			el.addEventListener('blur', function () {
				this.classList.add('focus');
			});
		}
	}());


	// ===== adaptiv =====

	(function () {
		var dataMove = document.querySelector('[data-move]');

		if (dataMove) {

			var mqls = [
				window.matchMedia('(max-width: 991px)'),
				window.matchMedia('(max-width: 767px)'),
			]

			for (var i = 0; i < mqls.length; i++) {
				mqls[i].addListener(move.bind(null, i));
				move(i);
			}

			function move(num) {
				var itemsMove = document.querySelectorAll('[data-media="' + num + '"]');

				if (itemsMove) {
					for (var i = 0; i < itemsMove.length; i++) {
						var itemMove = itemsMove[i];
						var itemNamber = itemMove.getAttribute('data-move');
						var startMove = document.querySelector('[data-start="' + itemNamber + '"]');
						var whereMove = document.querySelector('[data-where="' + itemNamber + '"]');

						if (mqls[num].matches) {
							if (!itemMove.classList.contains('done')) {
								whereMove.appendChild(itemMove);
								itemMove.classList.add('done');
							}
						} else {
							if (itemMove.classList.contains('done')) {
								startMove.appendChild(itemMove);
								itemMove.classList.remove('done');
							}
						}
					}
				}
			}
		}
	}());

 


	// ===== menu drop ===== 

	(function () {

		var btnDrop = document.querySelectorAll('[data-drop]');
		if (btnDrop) {
			for (var i = 0; i < btnDrop.length; i++) {

				var link = btnDrop[i].parentElement.querySelector('a');
				var label = '<span class="visually-hidden">открыть подменю для“' + link.text + '”</span>';
				btnDrop[i].insertAdjacentHTML('beforeend', label);

				btnDrop[i].addEventListener('click', function (e) {
					if (this.classList.contains('active')) {
						this.classList.remove('active');
						this.nextElementSibling.classList.remove('show');
						this.setAttribute('aria-expanded', "false");
						this.parentElement.querySelector('a').setAttribute('aria-expanded', "false");
					} else {
						this.classList.add('active');
						this.nextElementSibling.classList.add('show');
						this.setAttribute('aria-expanded', "true");
						this.parentElement.querySelector('a').setAttribute('aria-expanded', "true");
					}
				});
			}
		}

	}());



	// ===== navigation ===== 

	(function () {
		var burger = document.querySelector('.burger');
		var close = document.querySelector('.btn-close');
		var nav = document.querySelector('.navbar');
		var head = document.querySelector('.head');
		var overlay = document.querySelector('.overlay');
		var body = document.querySelector('body');

		if (burger) {
			burger.addEventListener('click', toggleMenu);
		}
		if (close) {
			close.addEventListener('click', closeMenu);
		}

		function toggleMenu() {
			this.classList.toggle('active');
			nav.classList.toggle('active');
			head.classList.toggle('active');
			overlay.classList.toggle('active');
			body.classList.toggle('lock');
			// swipe(nav);
		}

		function closeMenu() {
			burger.classList.remove('active');
			nav.classList.remove('active');
			head.classList.remove('active');
			overlay.classList.remove('active');
			body.classList.remove('lock');
		}

		var links = nav.querySelectorAll('a[href^="#"]');
		for (var i = 0; i < links.length; i += 1) {
			links[i].addEventListener('click', closeMenu);
		}


		// ===== head =====

		if (head) {
			document.addEventListener('scroll', smallHead);

			function smallHead() {
				if (window.pageYOffset) {
					head.classList.add('scroll');
					if (overlay) {
						overlay.classList.add('scroll');
					}
				} else {
					head.classList.remove('scroll');
					if (overlay) {
						overlay.classList.remove('scroll');
					}
				}
			}


			// ===== hide head =====

			document.addEventListener('scroll', hideHead);

			var lastScrollPos = 0;
			var start = true;

			function hideHead() {
				if (start) {
					start = false;

					setTimeout(function () {
						var scrollPos = window.pageYOffset;
						var headHeight = head.offsetHeight;

						if (!head.classList.contains('active')) {
							if (scrollPos > headHeight && scrollPos > lastScrollPos) {
								head.classList.add('hide');
							} else {
								head.classList.remove('hide');
							}
						}
						lastScrollPos = scrollPos;
						start = true;
					}, 200);
				}
			}
		}


		// ===== swipe =====

		function swipe(elem) {

			var touchstartX = 0;
			var touchstartY = 0;
			var touchendX = 0;
			var touchendY = 0;
			var minDist = 10;  // px
			// var maxDist = 120;
			var startTime = 0;
			var endTime = 0;

			var minSpeed = 1.0;

			elem.addEventListener('touchstart', touchstart, { passive: true });
			elem.addEventListener('touchend', touchend);

			function touchstart(event) {
				touchstartX = event.changedTouches[0].screenX;
				touchstartY = event.changedTouches[0].screenY;
				startTime = new Date().getTime();
			}

			function touchend(event) {
				touchendX = event.changedTouches[0].screenX;
				touchendY = event.changedTouches[0].screenY;
				endTime = new Date().getTime();
				getDirection();
			}

			function getDirection() {
				var dx = touchendX - touchstartX;
				var dy = touchendY - touchstartY;
				var abs_dx = Math.abs(dx);
				var abs_dy = Math.abs(dy);

				var time = endTime - startTime;
				var speedX = abs_dx / time;
				var speedY = abs_dy / time;

				if (speedX > minSpeed || speedY > minSpeed) {

					if (abs_dx > minDist && abs_dx > abs_dy) {
						if (dx < 0) {
							elem.dispatchEvent(new CustomEvent("onSwipeLeft"));
						} else {
							elem.dispatchEvent(new CustomEvent("onSwipeRight"));
						}
					}

					if (abs_dy > minDist && abs_dy > abs_dx) {
						if (dy < 0) {
							elem.dispatchEvent(new CustomEvent("onSwipeUp"));
						} else {
							elem.dispatchEvent(new CustomEvent("onSwipeDown"));
						}
					}
				}
			}
		}
		swipe(nav);
		nav.addEventListener("onSwipeUp", closeMenu);

	}());



	function scrollMenu(nav, offset, speed, easing) {

		var menu = document.querySelector(nav);
		var menuHeight;
		if (offset) {
			var head = document.querySelector(offset);

			if (head) {
				menuHeight = head.clientHeight;
				// отступ под меню
				// document.body.style.paddingTop = menuHeight + 'px';

			} else {
				menuHeight = 0;
			}
		} else {
			menuHeight = 0;
		}

		function fncAnimation(callback) {
			window.setTimeout(callback, 1000 / 60);
		};

		window.requestAnimFrame = function () {
			return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || fncAnimation;
		}();


		function scrollToY(height, speed, easing) {
			var scrollTargetY = height || 0;
			scrollTargetY += 2;
			var speed = speed || 2000;
			var easing = easing || 'easeOutSine';

			var scrollY = window.pageYOffset;
			var currentTime = 0;
			var time = Math.max(0.1, Math.min(Math.abs(scrollY - scrollTargetY) / speed, 0.8));

			var easingEquations = {
				easeOutSine: function easeOutSine(pos) {
					return Math.sin(pos * (Math.PI / 2));
				},
				easeInOutSine: function easeInOutSine(pos) {
					return -0.5 * (Math.cos(Math.PI * pos) - 1);
				},
				easeInOutQuint: function easeInOutQuint(pos) {
					/* eslint-disable-next-line */
					if ((pos /= 0.5) < 1) {
						return 0.5 * Math.pow(pos, 5);
					}
					return 0.5 * (Math.pow(pos - 2, 5) + 2);
				}
			};

			function tick() {
				currentTime += 1 / 60;
				var p = currentTime / time;
				var t = easingEquations[easing](p);

				if (p < 1) {
					window.requestAnimFrame(tick);
					window.scrollTo(0, scrollY + (scrollTargetY - scrollY) * t);
				} else {
					window.scrollTo(0, scrollTargetY);
				}
			}

			tick();
		};

		function menuControl(menu) {
			var i = void 0;
			var currLink = void 0;
			var refElement = void 0;
			var links = menu.querySelectorAll('a[href^="#"]');
			var scrollY = window.pageYOffset;

			for (i = 0; i < links.length; i += 1) {
				currLink = links[i];
				refElement = document.querySelector(currLink.getAttribute('href'));

				if (refElement) {
					var box = refElement.getBoundingClientRect();

					var topElem = box.top + scrollY - menuHeight;

					if (topElem <= scrollY && topElem + refElement.clientHeight > scrollY) {
						currLink.classList.add('active');
					} else {
						currLink.classList.remove('active');
					}
				}
			}
		}

		function animated(menu, speed, easing) {

			function control(e) {
				e.preventDefault();
				if (head) {
					menuHeight = head.clientHeight;
				} else {
					menuHeight = 0;
				}
				var elem = document.querySelector(this.hash);
				if (elem) {
					var box = elem.getBoundingClientRect();
					var topElem = box.top + window.pageYOffset;
					scrollToY(topElem - menuHeight, speed, easing);
				}
			}

			var i = void 0;
			var link = void 0;
			var links = menu.querySelectorAll('a[href^="#"]');

			for (i = 0; i < links.length; i += 1) {
				link = links[i];
				link.addEventListener('click', control);
			}
		}

		animated(menu, speed, easing);
		document.addEventListener('scroll', function () {
			menuControl(menu);
		});
	}
	scrollMenu('.menu', '.head');





	// ======== map ======== 

	function initMap() {
		var minePos = new google.maps.LatLng(-37.86335618156383, 145.16097272027184);

		var mapBox = document.getElementById('map');


		var styles_Snazzy = [
			{
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#f5f5f5"
					}
				]
			},
			{
				"elementType": "labels.icon",
				"stylers": [
					{
						"visibility": "off"
					}
				]
			},
			{
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#616161"
					}
				]
			},
			{
				"elementType": "labels.text.stroke",
				"stylers": [
					{
						"color": "#f5f5f5"
					}
				]
			},
			{
				"featureType": "administrative.land_parcel",
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#bdbdbd"
					}
				]
			},
			{
				"featureType": "poi",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#eeeeee"
					}
				]
			},
			{
				"featureType": "poi",
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#757575"
					}
				]
			},
			{
				"featureType": "poi.park",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#e5e5e5"
					}
				]
			},
			{
				"featureType": "poi.park",
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#9e9e9e"
					}
				]
			},
			{
				"featureType": "road",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#ffffff"
					}
				]
			},
			{
				"featureType": "road.arterial",
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#757575"
					}
				]
			},
			{
				"featureType": "road.highway",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#dadada"
					}
				]
			},
			{
				"featureType": "road.highway",
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#616161"
					}
				]
			},
			{
				"featureType": "road.local",
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#9e9e9e"
					}
				]
			},
			{
				"featureType": "transit.line",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#e5e5e5"
					}
				]
			},
			{
				"featureType": "transit.station",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#eeeeee"
					}
				]
			},
			{
				"featureType": "water",
				"elementType": "geometry",
				"stylers": [
					{
						"color": "#c9c9c9"
					}
				]
			},
			{
				"featureType": "water",
				"elementType": "labels.text.fill",
				"stylers": [
					{
						"color": "#9e9e9e"
					}
				]
			}
		]

		var mapOptions = {
			center: minePos,
			zoom: 12, // 0 - 21
			disableDefaultUI: true,
			styles: styles_Snazzy,
			// mapTypeId: google.maps.MapTypeId.SATELLITE,  // спутник
		};

		if (mapBox) {
			var map = new google.maps.Map(mapBox, mapOptions);
		}

		// ======== one google Marker ========

		var mainMarker = new google.maps.Marker({
			position: minePos,
			map: map,
			// title: "Текст всплывающей подсказки", 
			icon: "img/pin.svg",
			// animation: google.maps.Animation.DROP 
		});


	}
	google.maps.event.addDomListener(window, "load", initMap);



	// ===== tabs-spoiler W3C =====

	(function () {

		var accord = document.querySelectorAll('[data-accord]');
		if (accord) {

			for (let i = 0; i < accord.length; i++) {
				var accordion = accord[i];

				var allowMultiple = accordion.hasAttribute('data-allow-multiple');
				var allowToggle = (allowMultiple) ? allowMultiple : accordion.hasAttribute('data-allow-toggle');

				var triggers = Array.prototype.slice.call(accordion.querySelectorAll('[data-btn]'));
				accordion.addEventListener('click', change);

				function change(event) {
					var target = event.target;

					if (target.hasAttribute('data-btn')) {
						var isExpanded = target.getAttribute('aria-expanded') == 'true';
						var active = accordion.querySelector('[aria-expanded="true"]');

						if (!allowMultiple && active && active !== target) {
							active.setAttribute('aria-expanded', 'false');
							active.classList.remove('active');

							var panel1 = document.getElementById(active.getAttribute('aria-controls'));
							panel1.style.height = "0px";
							panel1.classList.remove('active');

							if (!allowToggle) {
								active.removeAttribute('aria-disabled');
							}
						}

						if (!isExpanded) {
							target.setAttribute('aria-expanded', 'true');
							target.classList.add('active');

							var pan = document.getElementById(target.getAttribute('aria-controls'));
							pan.style.height = pan.scrollHeight + 'px';
							pan.classList.add('active');

							if (!allowToggle) {
								target.setAttribute('aria-disabled', 'true');
							}
						}
						else if (allowToggle && isExpanded) {
							target.setAttribute('aria-expanded', 'false');
							target.classList.remove('active');
							var panel2 = document.getElementById(target.getAttribute('aria-controls'));
							panel2.style.height = "0px";
							panel2.classList.remove('active');
						}
						event.preventDefault();
					}
				};

				accordion.addEventListener('keydown', function (event) {
					var target = event.target;
					var key = event.which.toString();

					// 33 = Page Up, 34 = Page Down
					var ctrlModifier = (event.ctrlKey && key.match(/33|34/));

					// 38 = Up, 40 = Down
					if (target.hasAttribute('data-btn')) {
						if (key.match(/38|40/) || ctrlModifier) {
							var index = triggers.indexOf(target);
							var direction = (key.match(/34|40/)) ? 1 : -1;
							var length = triggers.length;
							var newIndex = (index + length + direction) % length;

							triggers[newIndex].focus();

							event.preventDefault();
						}
						// 35 = End, 36 = Home keyboard operations
						else if (key.match(/35|36/)) {
							switch (key) {
								case '36':
									triggers[0].focus();
									break;
								case '35':
									triggers[triggers.length - 1].focus();
									break;
							}
							event.preventDefault();
						}
					}
				});

				var accordBtn = accordion.querySelectorAll('[data-btn]');
				for (let i = 0; i < accordBtn.length; i++) {
					var trigger = accordBtn[i];

					trigger.addEventListener('focus', function (event) {
						accordion.classList.add('focus');
					});

					trigger.addEventListener('blur', function (event) {
						accordion.classList.remove('focus');
					});
				}

				if (!allowToggle) {
					var expanded = accordion.querySelector('[aria-expanded="true"]');

					if (expanded) {
						expanded.setAttribute('aria-disabled', 'true');
					}
				}

				var oupen = accordion.querySelector('[aria-expanded="true"]');
				if (oupen) {
					var panel = document.getElementById(oupen.getAttribute('aria-controls'));
					panel.style.height = panel.scrollHeight + 'px';
					panel.classList.add('active');
				}
			}
		}
	}());




	// ===== clamp text =====

	(function () {
		if (window.innerWidth < 1200) {

			var elClamp = document.querySelectorAll('[data-clamp]');
			if (elClamp) {
				for (var i = 0; i < elClamp.length; i++) {

					var dataClamp = elClamp[i].getAttribute('data-clamp');
					var line = Number(dataClamp);
					clamp(elClamp[i], line);

					var lastChild = elClamp[i].lastChild;

					if (!(lastChild.offsetWidth < lastChild.scrollWidth)) {
						elClamp[i].nextElementSibling.classList.add('hidden');
						// elClamp[i].parentElement.querySelector('[data-clamp-btn]').classList.add('hidden');
					}
				}
			}

			var btn = document.querySelectorAll('[data-clamp-btn]');
			if (btn) {
				for (var i = 0; i < btn.length; i++) {
					btn[i].addEventListener('click', function () {

						var el = this.parentElement.querySelector('[data-clamp]');
						clamp(el, 0);
						this.classList.add('hidden');
					});
				}
			}
		}
	}());

});
